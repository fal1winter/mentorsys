<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mentor.mapper.ApplicationMapper">

    <!-- Result Map for Application -->
    <resultMap id="ApplicationResultMap" type="com.mentor.entity.Application">
        <id property="id" column="id"/>
        <result property="studentId" column="student_id"/>
        <result property="mentorId" column="mentor_id"/>
        <result property="status" column="status"/>
        <result property="applicationLetter" column="application_letter"/>
        <result property="researchProposal" column="research_proposal"/>
        <result property="studentMessage" column="student_message"/>
        <result property="mentorFeedback" column="mentor_feedback"/>
        <result property="applyTime" column="apply_time"/>
        <result property="responseTime" column="response_time"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <!-- Insert Application -->
    <insert id="insertApplication" parameterType="com.mentor.entity.Application" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO applications (
            student_id, mentor_id, status, application_letter, research_proposal,
            student_message, mentor_feedback, apply_time, response_time, create_time, update_time
        ) VALUES (
            #{studentId}, #{mentorId}, #{status}, #{applicationLetter}, #{researchProposal},
            #{studentMessage}, #{mentorFeedback}, #{applyTime}, #{responseTime}, #{createTime}, #{updateTime}
        )
    </insert>

    <!-- Update Application -->
    <update id="updateApplication" parameterType="com.mentor.entity.Application">
        UPDATE applications
        <set>
            <if test="status != null">status = #{status},</if>
            <if test="applicationLetter != null">application_letter = #{applicationLetter},</if>
            <if test="researchProposal != null">research_proposal = #{researchProposal},</if>
            <if test="studentMessage != null">student_message = #{studentMessage},</if>
            <if test="mentorFeedback != null">mentor_feedback = #{mentorFeedback},</if>
            <if test="responseTime != null">response_time = #{responseTime},</if>
            update_time = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <!-- Get Application by ID -->
    <select id="getApplicationById" resultMap="ApplicationResultMap">
        SELECT * FROM applications WHERE id = #{id}
    </select>

    <!-- Get Application by Student and Mentor -->
    <select id="getApplicationByStudentAndMentor" resultMap="ApplicationResultMap">
        SELECT * FROM applications
        WHERE student_id = #{studentId} AND mentor_id = #{mentorId}
        ORDER BY create_time DESC
        LIMIT 1
    </select>

    <!-- Get Applications by Student ID -->
    <select id="getApplicationsByStudentId" resultMap="ApplicationResultMap">
        SELECT * FROM applications
        WHERE student_id = #{studentId}
        ORDER BY apply_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- Get Applications by Mentor ID -->
    <select id="getApplicationsByMentorId" resultMap="ApplicationResultMap">
        SELECT * FROM applications
        WHERE mentor_id = #{mentorId}
        ORDER BY apply_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- Get Applications by Status -->
    <select id="getApplicationsByStatus" resultMap="ApplicationResultMap">
        SELECT * FROM applications
        WHERE status = #{status}
        ORDER BY apply_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- Count Applications by Student -->
    <select id="countApplicationsByStudent" resultType="int">
        SELECT COUNT(*) FROM applications WHERE student_id = #{studentId}
    </select>

    <!-- Count Applications by Mentor -->
    <select id="countApplicationsByMentor" resultType="int">
        SELECT COUNT(*) FROM applications WHERE mentor_id = #{mentorId}
    </select>

    <!-- Count Pending Applications by Mentor -->
    <select id="countPendingApplicationsByMentor" resultType="int">
        SELECT COUNT(*) FROM applications WHERE mentor_id = #{mentorId} AND status = 'pending'
    </select>

    <!-- Get All Applications -->
    <select id="getAllApplications" resultMap="ApplicationResultMap">
        SELECT * FROM applications
        ORDER BY apply_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- Count All Applications -->
    <select id="countAllApplications" resultType="int">
        SELECT COUNT(*) FROM applications
    </select>

</mapper>
